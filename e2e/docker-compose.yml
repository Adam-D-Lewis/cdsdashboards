version: '2'
services:
  cdsdashboards:
    build:
      context: ../
      args:
        BASE_IMAGE: ${JH_CYPRESS_BASE_IMAGE}
    command: ["jupyterhub"]
    environment:
      - JH_CYPRESS_JHCONFIG_SRC=${JH_CYPRESS_JHCONFIG_SRC}
      - JH_CYPRESS_JHCONFIG_DEST=${JH_CYPRESS_JHCONFIG_DEST}
      - JH_CYPRESS_SQLITE_SRC=${JH_CYPRESS_SQLITE_SRC}
      - JH_CYPRESS_SQLITE_DEST=${JH_CYPRESS_SQLITE_DEST}
      - JH_CYPRESS_HOME_SRC=${JH_CYPRESS_HOME_SRC}
      - JH_CYPRESS_HOME_DEST=${JH_CYPRESS_HOME_DEST}
      - JH_CYPRESS_CREATE_USERS=${JH_CYPRESS_CREATE_USERS}
    volumes:
      - ./jupyterhub_config:/jh_cypress_config
    labels:
      - "com.containds.e2etest=container"

  cypress:
    image: "cypress/included:4.4.0"
    depends_on:
      - cdsdashboards
    command: ["--spec", "${JH_CYPRESS_TESTS}"]
    environment:
      - CYPRESS_baseUrl=http://cdsdashboards:80
    working_dir: /e2e
    volumes:
      - ./:/e2e
